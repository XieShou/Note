# xLua源码：LuaEnv

先看一个案例：

```csharp
void Start()
{
    LuaEnv env1 = new LuaEnv();
    env1.DoString("a = 1");
    env1.DoString("print('env1.a = ' .. tostring(a))");
    LuaEnv env2 = new LuaEnv();
    env2.DoString("print('env2.a = ' .. tostring(a))");
})");
```

结果如下：

```
env1.a = 1
env2.a = nil
```

可以简单的分析下，得到结论：xLua的两个LuaEnv对应Lua层的两个不同的Lua虚拟机，彼此之间存在内存隔离。

听坊间传闻，有使用者为了避免内存泄漏，一个玩法场景对应一个LuaEnv，在退出时销毁。

同时在源码中对虚拟机进行交互时，要像写Lua的C部分一样，带上对应的L参数，例如：

```csharp
public class SystemObjectWrap 
{
    public static void __Register(RealStatePtr L){ //... }
}
```

## 从LuaEnv开始

首先看到LuaEnv的构造函数，`LuaEnv.cs`：

```csharp
public class LuaEnv : IDisposable
{
    //...
    public LuaEnv()
    {
        //... 版本检查
        LuaIndexes.LUA_REGISTRYINDEX = LuaAPI.xlua_get_registry_index();

        //step1：创建虚拟机，初始化基础库
        rawL = LuaAPI.luaL_newstate();
        LuaAPI.luaopen_xlua(rawL);
        LuaAPI.luaopen_i64lib(rawL);
        //step2：初始化这个LuaEnv类实例对应的ObjectTranslator
        translator = new ObjectTranslator(this, rawL);
        translator.createFunctionMetatable(rawL);
        translator.OpenLib(rawL);
        ObjectTranslatorPool.Instance.Add(rawL, translator);
        //一个注册到C层的抛异常回调
        LuaAPI.lua_atpanic(rawL, StaticLuaCallbacks.Panic);
#if !XLUA_GENERAL
        //step3：向Lua层注册print函数回调
        LuaAPI.lua_pushstdcallcfunction(rawL, StaticLuaCallbacks.Print);
        if (0 != LuaAPI.xlua_setglobal(rawL, "print"))
        {
            throw new Exception("call xlua_setglobal fail!");
        }
#endif
        //step4：注册template{ compile = Compile, excute = Excute}两个函数回调
        TemplateEngine.LuaTemplate.OpenLib(rawL);
        //step5：Lua层require搜索函数
        AddSearcher(StaticLuaCallbacks.LoadBuiltinLib, 2); // just after the preload searcher
        AddSearcher(StaticLuaCallbacks.LoadFromCustomLoaders, 3);
#if !XLUA_GENERAL
        AddSearcher(StaticLuaCallbacks.LoadFromResource, 4);
        AddSearcher(StaticLuaCallbacks.LoadFromStreamingAssetsPath, -1);
#endif
        //step6：xLua的lua层调用CSharp入口
        DoString(init_xlua, "Init");
        init_xlua = null;
        //xLua内置的socket库
#if (!UNITY_SWITCH && !UNITY_WEBGL) || UNITY_EDITOR
        AddBuildin("socket.core", StaticLuaCallbacks.LoadSocketCore);
        AddBuildin("socket", StaticLuaCallbacks.LoadSocketCore);
#endif
        AddBuildin("CS", StaticLuaCallbacks.LoadCS);

        //...一堆LuaIndexes.LUA_REGISTRYINDEX初始化变量
        //...一堆初始化结果检测_G,CS
        //step7：Initer如果已经存在，代表此实例非第一个LuaEnv实例
        if (initers != null)
        {
            for (int i = 0; i < initers.Count; i++)
            {
                initers[i](this, translator);
            }
        }
        translator.CreateArrayMetatable(rawL);
        translator.CreateDelegateMetatable(rawL);
        translator.CreateEnumerablePairs(rawL);
    }
    //...
}
```

以下只分析比较简单的步骤，复杂的部分会分模块。

##### step
